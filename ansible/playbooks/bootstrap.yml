# ansible/playbooks/bootstrap.yml
---
- name: Bootstrap homelab nodes
  hosts: all
  become: yes

  pre_tasks:
    - name: Display bootstrap information
      debug:
        msg: |
          Bootstrapping {{ inventory_hostname }}
          IP: {{ ansible_host }}
          User: {{ ansible_user }}
          Version: {{ bootstrap_version }}

    - name: Gather facts
      setup:
        gather_subset:
          - '!all'
          - '!min'
          - hardware
          - network
          - virtual

    - name: Check if node was previously bootstrapped
      stat:
        path: "{{ bootstrap_state_dir }}/bootstrap-state.json"
      register: bootstrap_state_file

    - name: Read previous bootstrap state
      when: bootstrap_state_file.stat.exists
      slurp:
        src: "{{ bootstrap_state_dir }}/bootstrap-state.json"
      register: previous_state

    - name: Parse previous state
      when: bootstrap_state_file.stat.exists
      set_fact:
        previous_bootstrap_version: "{{ (previous_state.content | b64decode | from_json).version }}"

    - name: Display previous state
      when: bootstrap_state_file.stat.exists
      debug:
        msg: "Previous bootstrap version: {{ previous_bootstrap_version }}"

  roles:
    - role: ../roles/common
      tags: ['common', 'base']

    - role: ../roles/ssh
      tags: ['ssh', 'security']

    - role: ../roles/docker
      tags: ['docker', 'container']

    - role: ../roles/cifs
      tags: ['cifs', 'storage']

    - role: ../roles/gpu
      tags: ['gpu', 'nvidia']
      when:
        - node_labels is defined
        - node_labels.gpu | default(false)

    # - role: firewall # Excluded as per user's request
    #   tags: ['firewall', 'security']

  post_tasks:
    - name: Create bootstrap state directory
      file:
        path: "{{ bootstrap_state_dir }}"
        state: directory
        mode: '0755'

    - name: Generate bootstrap state
      copy:
        content: |
          {
            "version": "{{ bootstrap_version }}",
            "last_run": "{{ ansible_date_time.iso8601 }}",
            "hostname": "{{ ansible_hostname }}",
            "completed_roles": {{ ansible_play_role_names | to_json }},
            "system_info": {
              "os": "{{ ansible_distribution }} {{ ansible_distribution_version }}",
              "arch": "{{ ansible_architecture }}",
              "kernel": "{{ ansible_kernel }}",
              "memory_mb": {{ ansible_memtotal_mb }},
              "cpu_cores": {{ ansible_processor_vcpus }}
            },
            "docker_info": {
              "version": "{{ docker_installed_version | default('unknown') }}",
              "compose_version": "{{ docker_compose_installed_version | default('unknown') }}"
            },
            "gpu_detected": {{ gpu_present | default(false) | to_json }}
          }
        dest: "{{ bootstrap_state_dir }}/bootstrap-state.json"
        mode: '0644'

    - name: Display completion message
      debug:
        msg: |
          âœ“ Bootstrap complete for {{ inventory_hostname }}
          Version: {{ bootstrap_version }}
          State file: {{ bootstrap_state_dir }}/bootstrap-state.json
