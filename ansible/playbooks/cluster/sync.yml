# ansible/playbooks/cluster/sync.yml
---
- name: Detect and sync nodes that need to be rejoined
  hosts: managers
  become: yes

  tasks:
    - name: Get current swarm nodes with status
      shell: docker node ls --format "{{ '{{' }}.Hostname{{ '}}' }}:{{ '{{' }}.Status{{ '}}' }}"
      register: swarm_nodes_raw
      changed_when: false

    - name: Parse swarm node statuses
      set_fact:
        swarm_node_status: "{{ dict(swarm_nodes_raw.stdout_lines | map('split', ':') | list) }}"

    - name: Initialize nodes_to_sync list
      set_fact:
        nodes_to_sync: []

    - name: Check each worker node status
      set_fact:
        nodes_to_sync: "{{ nodes_to_sync + [item] }}"
      loop: "{{ groups['workers'] }}"
      when: >
        item not in swarm_node_status.keys() or
        swarm_node_status[item] == 'Down'

    - name: Display nodes that will be synced
      debug:
        msg: |
          Nodes to sync: {{ nodes_to_sync | join(', ') if nodes_to_sync | length > 0 else 'None' }}

          Current node statuses:
          {% for node, status in swarm_node_status.items() %}
          - {{ node }}: {{ status }}
          {% endfor %}

    - name: Exit if no nodes need syncing
      meta: end_play
      when: nodes_to_sync | length == 0

    - name: Confirm sync operation
      pause:
        prompt: |

          The following nodes will be removed and rejoined:
          {{ nodes_to_sync | join(', ') }}

          This is safe and will not affect data volumes.
          Press ENTER to continue or Ctrl+C to abort

    - name: Get worker join token
      command: docker swarm join-token worker -q
      register: worker_token
      changed_when: false

    - name: Remove stale node entries from swarm
      command: docker node rm --force {{ item }}
      loop: "{{ nodes_to_sync }}"
      when: item in swarm_node_status.keys()
      ignore_errors: yes

- name: Have nodes leave swarm locally
  hosts: workers
  become: yes
  vars:
    nodes_to_sync: "{{ hostvars[groups['managers'][0]].nodes_to_sync }}"

  tasks:
    - name: Skip if not in sync list
      meta: end_host
      when: inventory_hostname not in nodes_to_sync

    - name: Leave swarm
      command: docker swarm leave --force
      ignore_errors: yes

    - name: Wait for swarm to fully leave
      pause:
        seconds: 3

- name: Rejoin nodes to swarm with current IPs
  hosts: workers
  become: yes
  vars:
    nodes_to_sync: "{{ hostvars[groups['managers'][0]].nodes_to_sync }}"
    manager_ip: "{{ hostvars[groups['managers'][0]].ansible_host }}"

  tasks:
    - name: Skip if not in sync list
      meta: end_host
      when: inventory_hostname not in nodes_to_sync

    - name: Get worker token from manager
      command: docker swarm join-token worker -q
      register: worker_token
      delegate_to: "{{ groups['managers'][0] }}"
      changed_when: false
      run_once: true

    - name: Rejoin swarm with current IP ({{ ansible_host }})
      command: docker swarm join --token {{ worker_token.stdout }} {{ manager_ip }}:2377
      register: join_result
      retries: 3
      delay: 5
      until: join_result.rc == 0

    - name: Verify node rejoined successfully
      command: docker info --format '{{ "{{" }}.Swarm.LocalNodeState{{ "}}" }}'
      register: swarm_state
      changed_when: false
      failed_when: swarm_state.stdout != "active"

- name: Wait for nodes to be ready and show status
  hosts: managers
  become: yes
  vars:
    nodes_to_sync: "{{ nodes_to_sync }}"

  tasks:
    - name: Wait for nodes to be ready
      pause:
        seconds: 5

    - name: Get final cluster status
      command: docker node ls
      register: final_status
      changed_when: false

    - name: Display final cluster status
      debug:
        msg: |
          âœ… Cluster sync complete! Nodes rejoined successfully.

          {{ final_status.stdout }}

          Running label sync next...

# Import the existing update-labels playbook to restore node labels
- name: Restore node labels after sync
  import_playbook: update-labels.yml
