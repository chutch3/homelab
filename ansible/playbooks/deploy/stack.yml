# ansible/playbooks/deploy/stack.yml
---
- name: Deploy a single Docker Swarm stack
  hosts: managers
  vars:
      # Mandatory: Name of the stack to deploy
      stack_name: ""

  tasks:
      - name: Ensure stack_name is defined
        ansible.builtin.fail:
            msg: "The 'stack_name' variable must be defined (e.g., -e stack_name=my_app)."
        when: stack_name == ""

      - name: Check for compose file in stacks/ directory
        ansible.builtin.stat:
            path: "{{ (playbook_dir ~ '/../../../stacks/' ~ stack_name ~ '/docker-compose.yml') | realpath }}"
        register: compose_file_stacks

      - name: Check for compose file in stacks/apps/ directory
        ansible.builtin.stat:
            path: "{{ (playbook_dir ~ '/../../../stacks/apps/' ~ stack_name ~ '/docker-compose.yml') | realpath }}"
        register: compose_file_apps

      - name: Set compose file path
        ansible.builtin.set_fact:
            compose_file_path: "{{ compose_file_stacks.stat.path if compose_file_stacks.stat.exists else compose_file_apps.stat.path }}"

      - name: Debug - Print resolved compose file path
        ansible.builtin.debug:
            msg: "Resolved compose file path: {{ compose_file_path }}"

      - name: Fail if compose file does not exist
        ansible.builtin.fail:
            msg: "Compose file not found at: {{ compose_file_path }}"
        when: not compose_file_stacks.stat.exists and not compose_file_apps.stat.exists

      - name: Load .env file
        ansible.builtin.slurp:
            src: "{{ playbook_dir }}/../../../.env"
        register: env_file_content

      - name: Parse environment variables from .env
        ansible.builtin.set_fact:
            env_vars: "{{ dict(env_file_content.content | b64decode | regex_findall('^([A-Z_0-9]+)=(.*)$', multiline=True)) }}"

      - name: Attempt to deploy as an application stack
        community.docker.docker_stack:
            state: present
            name: "{{ stack_name }}"
            compose:
                - "{{ compose_file_path }}"
        environment: "{{ env_vars }}"
        register: deploy_app_result
        ignore_errors: no

      - name: Report successful deployment
        debug:
            msg: "Stack '{{ stack_name }}' deployed successfully."
        when: deploy_app_result is succeeded
