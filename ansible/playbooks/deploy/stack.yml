# ansible/playbooks/deploy/stack.yml
---
- name: Deploy a single Docker Swarm stack
  hosts: managers
  vars:
      # Mandatory: Name of the stack to deploy
      stack_name: ""
      # Optional: Register DNS (auto-detects new stacks, set to false to skip)
      register_dns: "auto"
      # Optional: Register uptime monitoring (auto-detects new stacks, set to false to skip)
      register_uptime: "auto"

  tasks:
      - name: Ensure stack_name is defined
        ansible.builtin.fail:
            msg: "The 'stack_name' variable must be defined (e.g., -e stack_name=my_app)."
        when: stack_name == ""

      - name: Check if stack already exists
        ansible.builtin.command: docker stack ls --format '{% raw %}{{.Name}}{% endraw %}'
        register: existing_stacks
        changed_when: false

      - name: Determine if this is a new stack deployment
        ansible.builtin.set_fact:
            is_new_stack: "{{ stack_name not in existing_stacks.stdout_lines }}"

      - name: Check for compose file in stacks/ directory
        ansible.builtin.stat:
            path: "{{ (playbook_dir ~ '/../../../stacks/' ~ stack_name ~ '/docker-compose.yml') | realpath }}"
        register: compose_file_stacks

      - name: Check for compose file in stacks/apps/ directory
        ansible.builtin.stat:
            path: "{{ (playbook_dir ~ '/../../../stacks/apps/' ~ stack_name ~ '/docker-compose.yml') | realpath }}"
        register: compose_file_apps

      - name: Fail if compose file does not exist in either location
        ansible.builtin.fail:
            msg: |
              Stack '{{ stack_name }}' not found. Checked locations:
                - stacks/{{ stack_name }}/docker-compose.yml
                - stacks/apps/{{ stack_name }}/docker-compose.yml

              Available stacks:
                Infrastructure: monitoring, reverse-proxy, dns
                Apps: Run 'ls stacks/apps/' to see available application stacks
        when: not compose_file_stacks.stat.exists and not compose_file_apps.stat.exists

      - name: Set compose file path
        ansible.builtin.set_fact:
            compose_file_path: "{{ compose_file_stacks.stat.path if compose_file_stacks.stat.exists else compose_file_apps.stat.path }}"

      - name: Debug - Print resolved compose file path
        ansible.builtin.debug:
            msg: "Resolved compose file path: {{ compose_file_path }}"

      - name: Load .env file
        ansible.builtin.slurp:
            src: "{{ playbook_dir }}/../../../.env"
        register: env_file_content

      - name: Parse environment variables from .env
        ansible.builtin.set_fact:
            env_vars: "{{ dict(env_file_content.content | b64decode | regex_findall('^([A-Z_0-9]+)=(.*)$', multiline=True)) }}"

      - name: Attempt to deploy as an application stack
        community.docker.docker_stack:
            state: present
            name: "{{ stack_name }}"
            compose:
                - "{{ compose_file_path }}"
        environment: "{{ env_vars }}"
        register: deploy_app_result
        ignore_errors: no

      - name: Report successful deployment
        ansible.builtin.debug:
            msg: "Stack '{{ stack_name }}' deployed successfully{{ ' (new stack)' if is_new_stack else ' (updated)' }}."
        when: deploy_app_result is succeeded

      - name: Set DNS registration flag
        ansible.builtin.set_fact:
            should_register_dns: "{{ (register_dns == 'auto' and is_new_stack) or (register_dns | bool) }}"
        when: register_dns

      - name: Set uptime registration flag
        ansible.builtin.set_fact:
            should_register_uptime: "{{ (register_uptime == 'auto' and is_new_stack) or (register_uptime | bool) }}"
        when: register_uptime

      - name: Get DNS API token
        ansible.builtin.include_role:
            name: dns
            tasks_from: get-token
        when: should_register_dns | default(false)

      - name: Register DNS for new stack
        ansible.builtin.include_role:
            name: dns
            tasks_from: add-service-cnames
        vars:
            dns_base_domain: "{{ lookup('env', 'BASE_DOMAIN') }}"
        when: should_register_dns | default(false)

      - name: Get uptime API token
        ansible.builtin.include_role:
            name: uptime_kuma
            tasks_from: get-token
        when: should_register_uptime | default(false)

      - name: Register uptime monitoring for new stack
        ansible.builtin.include_role:
            name: uptime_kuma
            tasks_from: add-service-monitors
        vars:
            uptime_kuma_base_domain: "{{ lookup('env', 'BASE_DOMAIN') }}"
        when: should_register_uptime | default(false)

      - name: Deployment summary
        ansible.builtin.debug:
            msg: |
                âœ… Stack '{{ stack_name }}' deployed successfully
                   - Status: {{ 'New deployment' if is_new_stack else 'Updated existing stack' }}
                   - DNS registered: {{ 'Yes' if should_register_dns | default(false) else 'No' }}
                   - Uptime monitoring: {{ 'Yes' if should_register_uptime | default(false) else 'No' }}
