# ansible/playbooks/ops/teardown-stack.yml
---
- name: Tear down a single Docker Swarm stack and optionally its volumes
  hosts: managers
  vars:
    # Mandatory: Name of the stack to tear down
    stack_name: ""
    # Optional: Set to true to remove associated volumes
    remove_volumes: false
    # Optional: Set to false to preserve DNS records (default: true)
    remove_dns: true
    # Optional: Set to false to preserve uptime monitoring (default: true)
    remove_uptime: true

  tasks:
    - name: Ensure stack_name is defined
      fail:
        msg: "The 'stack_name' variable must be defined (e.g., -e stack_name=my_app)."
      when: stack_name == ""

    - name: Get volumes associated with the stack (by label)
      command: 'docker volume ls --filter label=com.docker.stack.namespace={{ stack_name }} --format ''{% raw %}{{ .Name }}{% endraw %}'''
      register: stack_volumes_by_label
      changed_when: false
      when: remove_volumes

    - name: Get volumes associated with the stack (by name prefix - fallback)
      command: 'docker volume ls --filter name={{ stack_name }}_ --format ''{% raw %}{{ .Name }}{% endraw %}'''
      register: stack_volumes_by_name
      changed_when: false
      when: remove_volumes and (stack_volumes_by_label.stdout_lines | default([]) | length == 0)

    - name: Read docker-compose.yml to find volume names (locally)
      set_fact:
        compose_content: "{{ lookup('file', playbook_dir + '/../../../stacks/apps/' + stack_name + '/docker-compose.yml', errors='ignore') | from_yaml }}"
      when: remove_volumes and (stack_volumes_by_label.stdout_lines | default([]) | length == 0) and (stack_volumes_by_name.stdout_lines | default([]) | length == 0)
      ignore_errors: true

    - name: Parse volume names from docker-compose.yml
      set_fact:
        compose_volumes: "{{ compose_content.volumes.keys() | list }}"
      when: remove_volumes and compose_content is defined and compose_content.volumes is defined

    - name: Check which compose volumes actually exist
      command: "docker volume inspect {{ item }}"
      loop: "{{ compose_volumes | default([]) }}"
      register: volume_exists
      failed_when: false
      changed_when: false
      when: remove_volumes and compose_volumes is defined

    - name: Build list of existing volumes from compose file
      set_fact:
        stack_volumes_from_compose: "{{ volume_exists.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list }}"
      when: remove_volumes and volume_exists is defined and volume_exists.results is defined

    - name: Combine volume lists
      set_fact:
        stack_volumes: "{{ (stack_volumes_by_label.stdout_lines | default([])) + (stack_volumes_by_name.stdout_lines | default([])) + (stack_volumes_from_compose | default([])) }}"
      when: remove_volumes

    - name: Remove the Docker Swarm stack
      ansible.builtin.command:
        cmd: "docker stack rm {{ stack_name }}"
      register: stack_removal
      failed_when: false
      changed_when: stack_removal.rc == 0

    - name: Wait for stack to fully stop
      pause:
        seconds: 5
      when: remove_volumes and stack_volumes | length > 0

    - name: Remove associated Docker volumes
      when: remove_volumes and stack_volumes | length > 0
      ansible.builtin.command:
        cmd: "docker volume rm -f {{ item }}"
      loop: "{{ stack_volumes }}"
      register: volume_removal
      failed_when: false

    - name: Get DNS API token
      ansible.builtin.include_role:
        name: dns
        tasks_from: get-token
      when: remove_dns | bool

    - name: Remove DNS records for stack
      ansible.builtin.include_role:
        name: dns
        tasks_from: remove-service-cnames
      vars:
        dns_base_domain: "{{ lookup('env', 'BASE_DOMAIN') }}"
      when: remove_dns | bool

    - name: Get uptime API token
      ansible.builtin.include_role:
        name: uptime_kuma
        tasks_from: get-token
      when: remove_uptime | bool

    - name: Remove uptime monitors for stack
      ansible.builtin.include_role:
        name: uptime_kuma
        tasks_from: remove-service-monitors
      vars:
        uptime_kuma_base_domain: "{{ lookup('env', 'BASE_DOMAIN') }}"
      when: remove_uptime | bool

    - name: Teardown summary
      ansible.builtin.debug:
        msg: |
          âœ… Stack '{{ stack_name }}' teardown complete
             - Stack removed: Yes
             - Volumes removed: {{ 'Yes (' + (stack_volumes | default([]) | join(', ')) + ')' if remove_volumes and stack_volumes | default([]) | length > 0 else ('No' if not remove_volumes else 'None found') }}
             - DNS records removed: {{ 'Yes' if remove_dns | bool else 'No (preserved)' }}
             - Uptime monitors removed: {{ 'Yes' if remove_uptime | bool else 'No (preserved)' }}
