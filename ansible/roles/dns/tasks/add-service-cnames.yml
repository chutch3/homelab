# ansible/roles/dns/tasks/add-service-cnames.yml
---
- name: Find all docker-compose.yml files
  find:
    paths: "{{ playbook_dir }}/../../stacks/apps"
    patterns: "docker-compose.yml"
    recurse: yes
  register: dns_compose_files
  delegate_to: localhost

- name: Get only compose files with Traefik Host() rules
  shell: "grep -l 'Host(' {{ item.path }}"
  loop: "{{ dns_compose_files.files }}"
  register: dns_traefik_compose_files
  changed_when: false
  failed_when: false # Ignore rc=1 when no matches
  delegate_to: localhost

- name: Extract Traefik Host() rules
  shell: "grep -o 'Host(`.*`)' {{ item.path }}"
  loop: "{{ dns_traefik_compose_files.results | selectattr('rc', '==', 0) | map(attribute='item') | list }}"
  register: dns_traefik_rules
  changed_when: false
  failed_when: false # Ignore rc=1 when no matches
  delegate_to: localhost

- name: Process and set discovered domains
  set_fact:
    dns_discovered_domains: >
      {{ dns_traefik_rules.results |
         map(attribute='stdout_lines') | flatten |
         map('regex_search', 'Host\(`([^`]+)`\)', '\1') |
         flatten | select('ne', '') |
         map('regex_replace', '\$\{BASE_DOMAIN\}', base_domain) |
         unique | list }}

- name: Display Discovered Domains
  debug:
    msg: "Discovered {{ dns_discovered_domains | length }} domains: {{ dns_discovered_domains }}"

- name: Get manager hostname
  set_fact:
    dns_manager_hostname: "{{ groups['managers'][0] }}"

- name: Add CNAME record for each discovered service
  uri:
    url: "{{ dns_api_url }}/zones/records/add"
    method: POST
    body_format: form-urlencoded
    body:
      token: "{{ dns_api_token }}"
      domain: "{{ item }}"
      zone: "{{ base_domain }}"
      type: "CNAME"
      cname: "{{ dns_manager_hostname }}.{{ base_domain }}"
      ttl: "3600"
    status_code: 200
  loop: "{{ dns_discovered_domains }}"
  register: dns_add_cname_result

- name: Display CNAME record addition status
  debug:
    msg: "CNAME for {{ item.item }}: {{ 'Record already exists' if item.json.status == 'error' and 'already exists' in item.json.get('errorMessage', '') else 'Created/Updated' }}"
  loop: "{{ dns_add_cname_result.results }}"
