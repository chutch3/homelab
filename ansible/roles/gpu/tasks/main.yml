# ansible/roles/gpu/tasks/main.yml
---
- name: Check for NVIDIA GPU
  shell: lspci | grep -i nvidia
  register: nvidia_check
  changed_when: false
  failed_when: false

- name: Set GPU present fact
  set_fact:
    gpu_present: "{{ nvidia_check.rc == 0 }}"

- name: Display GPU detection result
  debug:
    msg: "NVIDIA GPU {{ 'detected' if gpu_present else 'not detected' }}"

- name: Skip GPU setup if no GPU present
  meta: end_play
  when: not gpu_present

- name: Download and install NVIDIA Container Toolkit GPG key
  shell: |
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
      gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  args:
    creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

- name: Add NVIDIA Container Toolkit repository
  shell: |
    curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
  args:
    creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list

- name: Install NVIDIA Container Toolkit
  apt:
    name: nvidia-container-toolkit
    state: present
    update_cache: yes

- name: Check if NVIDIA runtime is already configured
  shell: grep -q '"nvidia"' /etc/docker/daemon.json || echo "not_configured"
  register: nvidia_runtime_check
  changed_when: false
  failed_when: false

- name: Configure Docker for NVIDIA runtime
  command: nvidia-ctk runtime configure --runtime=docker
  notify: restart docker
  when: nvidia_runtime_check.stdout == "not_configured"

- name: Get GPU UUIDs for Swarm generic resources
  shell: |
    nvidia-smi -L | grep -oP 'UUID: \K[^)]+' | awk '{print "NVIDIA-GPU="$1}' | paste -sd ','
  register: gpu_uuids
  changed_when: false

- name: Display detected GPU UUIDs
  debug:
    msg: "Detected GPUs: {{ gpu_uuids.stdout }}"

- name: Read current Docker daemon.json
  slurp:
    src: /etc/docker/daemon.json
  register: daemon_json_content
  failed_when: false

- name: Parse current daemon.json or create new
  set_fact:
    daemon_json: "{{ daemon_json_content.content | b64decode | from_json if daemon_json_content.content is defined else {} }}"

- name: Add generic resources to daemon.json
  set_fact:
    daemon_json: "{{ daemon_json | combine({'node-generic-resources': gpu_uuids.stdout.split(',')}, recursive=true) }}"
  when: gpu_uuids.stdout | length > 0

- name: Ensure nvidia runtime is set as default
  set_fact:
    daemon_json: "{{ daemon_json | combine({'default-runtime': 'nvidia'}, recursive=true) }}"

- name: Write updated daemon.json
  copy:
    content: "{{ daemon_json | to_nice_json }}\n"
    dest: /etc/docker/daemon.json
    mode: '0644'
  notify: restart docker

- name: Configure NVIDIA Container Runtime for Swarm
  lineinfile:
    path: /etc/nvidia-container-runtime/config.toml
    regexp: '^#?\s*swarm-resource\s*='
    line: 'swarm-resource = "DOCKER_RESOURCE_NVIDIA-GPU"'
    state: present
  notify: restart docker

- name: Flush handlers to restart Docker
  meta: flush_handlers

- name: Test GPU in container
  command: >
    docker run --rm --gpus all
    nvidia/cuda:12.0.0-base-ubuntu22.04
    nvidia-smi
  changed_when: false
  register: gpu_test
  when: nvidia_runtime_check.stdout == "not_configured"

- name: Display GPU test result
  debug:
    msg: "GPU test successful"
  when:
    - nvidia_runtime_check.stdout == "not_configured"
    - gpu_test.rc == 0
