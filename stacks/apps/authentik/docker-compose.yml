version: "3.9"

services:
    postgresql:
        image: docker.io/library/postgres:16-alpine
        environment:
            POSTGRES_PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
            POSTGRES_USER: authentik
            POSTGRES_DB: authentik
        volumes:
            - postgresql:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -d authentik -U authentik"]
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 20s
        networks:
            - authentik-internal
        deploy:
            placement:
                constraints:
                    - node.labels.database == true
            restart_policy:
                condition: any
                delay: 5s

    redis:
        image: docker.io/library/redis:alpine
        command: --save 60 1 --loglevel warning
        volumes:
            - redis:/data
        healthcheck:
            test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 20s
        networks:
            - authentik-internal
        deploy:
            placement:
                constraints:
                    - node.labels.database == true
            restart_policy:
                condition: any
                delay: 5s

    server:
        image: ghcr.io/goauthentik/server:2024.12.3
        command: server
        environment:
            AUTHENTIK_REDIS__HOST: redis
            AUTHENTIK_POSTGRESQL__HOST: postgresql
            AUTHENTIK_POSTGRESQL__USER: authentik
            AUTHENTIK_POSTGRESQL__NAME: authentik
            AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
            AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
            # AUTHENTIK_ERROR_REPORTING__ENABLED: "true"
        volumes:
            - media:/media
            - custom-templates:/templates
        networks:
            - authentik-internal
            - traefik-public
        depends_on:
            - postgresql
            - redis
        deploy:
            labels:
                - "traefik.enable=true"
                # Main Authentik server
                - "traefik.http.routers.authentik.rule=Host(`auth.${BASE_DOMAIN}`)"
                - "traefik.http.routers.authentik.entrypoints=websecure"
                - "traefik.http.routers.authentik.tls.certresolver=dns"
                - "traefik.http.services.authentik.loadbalancer.server.port=9000"
                - "traefik.swarm.network=traefik-public"
                # Homepage integration
                - homepage.group=Infrastructure
                - homepage.name=Authentik
                - homepage.icon=authentik.png
                - homepage.href=https://auth.${BASE_DOMAIN}/
                - homepage.description=Identity Provider
            restart_policy:
                condition: any
                delay: 5s

    worker:
        image: ghcr.io/goauthentik/server:2024.12.3
        command: worker
        environment:
            AUTHENTIK_REDIS__HOST: redis
            AUTHENTIK_POSTGRESQL__HOST: postgresql
            AUTHENTIK_POSTGRESQL__USER: authentik
            AUTHENTIK_POSTGRESQL__NAME: authentik
            AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
            AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
        # `user: root` and the docker socket are optional.
        # Required for:
        # - Docker socket-based outpost controller
        # - Container monitoring in Authentik
        user: root
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - media:/media
            - certs:/certs
            - custom-templates:/templates
        networks:
            - authentik-internal
        depends_on:
            - postgresql
            - redis
        deploy:
            placement:
                constraints:
                    - node.role == manager
            restart_policy:
                condition: any
                delay: 5s

    # Proxy Outpost - handles forward auth for Traefik
    # This is deployed automatically by Authentik when you create an outpost,
    # but you can also define it manually here for more control
    proxy:
        image: ghcr.io/goauthentik/proxy:2024.12.3
        environment:
            AUTHENTIK_HOST: https://auth.${BASE_DOMAIN}
            AUTHENTIK_INSECURE: "false"
            AUTHENTIK_TOKEN: ${AUTHENTIK_OUTPOST_TOKEN}
        networks:
            - traefik-public
        deploy:
            labels:
                - "traefik.enable=true"
                - "traefik.swarm.network=traefik-public"
                # ForwardAuth middleware definition
                - "traefik.http.middlewares.authentik.forwardauth.address=http://tasks.authentik_proxy:9000/outpost.goauthentik.io/auth/traefik"
                - "traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true"
                - "traefik.http.middlewares.authentik.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"
                # Outpost callback router for auth.domain - must have higher priority than main authentik router
                - "traefik.http.routers.authentik-outpost-callback.rule=Host(`auth.${BASE_DOMAIN}`) && PathPrefix(`/outpost.goauthentik.io/`)"
                - "traefik.http.routers.authentik-outpost-callback.entrypoints=websecure"
                - "traefik.http.routers.authentik-outpost-callback.tls.certresolver=dns"
                - "traefik.http.routers.authentik-outpost-callback.priority=200"
                - "traefik.http.routers.authentik-outpost-callback.service=authentik-outpost"
                # Outpost router for other subdomains
                - "traefik.http.routers.authentik-outpost.rule=HostRegexp(`{subdomain:[a-z0-9-]+}.${BASE_DOMAIN}`) && PathPrefix(`/outpost.goauthentik.io/`)"
                - "traefik.http.routers.authentik-outpost.entrypoints=websecure"
                - "traefik.http.routers.authentik-outpost.tls.certresolver=dns"
                - "traefik.http.routers.authentik-outpost.priority=100"
                - "traefik.http.services.authentik-outpost.loadbalancer.server.port=9000"
            restart_policy:
                condition: any
                delay: 5s

    # LDAP Outpost - provides LDAP interface for apps like Emby
    ldap:
        image: ghcr.io/goauthentik/ldap:2024.12.3
        ports:
            - "389:3389"
            - "636:6636"
        environment:
            AUTHENTIK_HOST: https://auth.${BASE_DOMAIN}
            AUTHENTIK_INSECURE: "false"
            AUTHENTIK_TOKEN: ${AUTHENTIK_LDAP_TOKEN}
        networks:
            - traefik-public
        deploy:
            restart_policy:
                condition: any
                delay: 5s

networks:
    authentik-internal:
        driver: overlay
    traefik-public:
        external: true

volumes:
    postgresql:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/app-data/authentik/postgresql"
    redis:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/cache/authentik-redis"
    media:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/app-data/authentik/media"
    custom-templates:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/app-data/authentik/templates"
    certs:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/app-data/authentik/certs"
