version: "3.9"

services:
    forgejo-db:
        image: postgres:14-alpine
        environment:
            POSTGRES_USER: ${FORGEJO_DB_USER:-forgejo}
            POSTGRES_PASSWORD: ${FORGEJO_DB_PASSWORD}
            POSTGRES_DB: ${FORGEJO_DB_NAME:-forgejo}
        volumes:
            - forgejo_db:/var/lib/postgresql/data
        networks:
            - forgejo-internal
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -d ${FORGEJO_DB_NAME:-forgejo} -U ${FORGEJO_DB_USER:-forgejo}",
                ]
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 20s
        deploy:
            replicas: 1
            restart_policy:
                condition: any
                delay: 5s

    forgejo:
        image: codeberg.org/forgejo/forgejo:13-rootless
        environment:
            - USER_UID=1000
            - USER_GID=1000
            - FORGEJO__database__DB_TYPE=postgres
            - FORGEJO__database__HOST=forgejo-db:5432
            - FORGEJO__database__NAME=${FORGEJO_DB_NAME:-forgejo}
            - FORGEJO__database__USER=${FORGEJO_DB_USER:-forgejo}
            - FORGEJO__database__PASSWD=${FORGEJO_DB_PASSWORD}
            - FORGEJO__server__DOMAIN=git.${BASE_DOMAIN}
            - FORGEJO__server__SSH_DOMAIN=git.${BASE_DOMAIN}
            - FORGEJO__server__ROOT_URL=https://git.${BASE_DOMAIN}/
            - FORGEJO__server__SSH_PORT=${FORGEJO_SSH_PORT:-2222}
            - FORGEJO__server__SSH_LISTEN_PORT=2222
            # Authentik OIDC Configuration
            - FORGEJO__openid__ENABLE_OPENID_SIGNIN=true
            - FORGEJO__openid__ENABLE_OPENID_SIGNUP=true
            - FORGEJO__service__DISABLE_REGISTRATION=false
            - FORGEJO__service__ALLOW_ONLY_EXTERNAL_REGISTRATION=false
        volumes:
            - forgejo_data:/var/lib/gitea
            - forgejo_config:/etc/gitea
        ports:
            - "${FORGEJO_SSH_PORT:-2222}:2222"
        networks:
            - forgejo-internal
            - traefik-public
        depends_on:
            - forgejo-db
        deploy:
            replicas: 1
            labels:
                # Traefik Labels
                - "traefik.enable=true"
                - "traefik.http.routers.forgejo.rule=Host(`git.${BASE_DOMAIN}`)"
                - "traefik.http.routers.forgejo.entrypoints=websecure"
                - "traefik.http.routers.forgejo.tls.certresolver=dns"
                - "traefik.http.services.forgejo.loadbalancer.server.port=3000"
                - "traefik.swarm.network=traefik-public"

                # Homepage Labels
                - "homepage.group=Development"
                - "homepage.name=Forgejo"
                - "homepage.icon=forgejo.png"
                - "homepage.href=https://git.${BASE_DOMAIN}/"
                - "homepage.description=Self-hosted Git Service"
            restart_policy:
                condition: any
                delay: 5s

networks:
    forgejo-internal:
        driver: overlay
    traefik-public:
        external: true

volumes:
    forgejo_db:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/app-data/forgejo/postgresql"

    forgejo_data:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/app-data/forgejo/data"

    forgejo_config:
        driver: local
        driver_opts:
            type: "none"
            o: "bind"
            device: "/mnt/iscsi/app-data/forgejo/config"
