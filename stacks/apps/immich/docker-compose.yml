version: "3.9"

services:
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    command: ["start.sh", "immich"]
    volumes:
      - immich_upload:/usr/src/app/upload
      - all_data:/mnt/media/photos:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      DB_HOSTNAME: immich-postgres
      DB_USERNAME: ${IMMICH_DB_USERNAME:-postgres}
      DB_PASSWORD: ${IMMICH_DB_PASSWORD}
      DB_DATABASE_NAME: ${IMMICH_DB_DATABASE_NAME:-immich}
      REDIS_HOSTNAME: immich-redis
      TZ: ${TZ:-UTC}
      UPLOAD_LOCATION: /usr/src/app/upload
      # Authentik OIDC Configuration
      OAUTH_ENABLED: "true"
      OAUTH_ISSUER_URL: https://auth.${BASE_DOMAIN}/application/o/immich/
      OAUTH_CLIENT_ID: ${IMMICH_OAUTH_CLIENT_ID}
      OAUTH_CLIENT_SECRET: ${IMMICH_OAUTH_CLIENT_SECRET}
      OAUTH_AUTO_REGISTER: "true"
      OAUTH_BUTTON_TEXT: "Login with Authentik"
      OAUTH_SCOPE: "openid email profile"
    depends_on:
      - immich-redis
      - immich-postgres
    restart: unless-stopped
    networks:
      - traefik-public
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.immich.rule=Host(`photos.${BASE_DOMAIN}`)"
        - "traefik.http.routers.immich.entrypoints=websecure"
        - "traefik.http.routers.immich.tls.certresolver=dns"
        - "traefik.http.services.immich.loadbalancer.server.port=2283"
        - "traefik.http.services.immich.loadbalancer.server.scheme=http"
        - homepage.group=Media
        - homepage.name=Immich
        - homepage.icon=immich.png
        - homepage.href=https://photos.${BASE_DOMAIN}/
        - homepage.description=Photo & Video Management

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}-cuda
    volumes:
      - immich_model_cache:/cache
    environment:
      NVIDIA_VISIBLE_DEVICES: "all"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python /usr/src/healthcheck.py || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - traefik-public
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.gpu == true

  immich-redis:
    image: registry.hub.docker.com/library/redis:6.2-alpine@sha256:84882e87b54734154586e5f8abd4dce69fe7311315e2fc6d67c29614c8de2672
    volumes:
      - immich_redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - traefik-public
    deploy:
      replicas: 1

  immich-postgres:
    image: registry.hub.docker.com/tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0
    environment:
      POSTGRES_PASSWORD: ${IMMICH_DB_PASSWORD}
      POSTGRES_USER: ${IMMICH_DB_USERNAME:-postgres}
      POSTGRES_DB: ${IMMICH_DB_DATABASE_NAME:-immich}
    volumes:
      - immich_pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d immich -U postgres || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - traefik-public
    deploy:
      replicas: 1
      placement:
        constraints:
          # Centralized database node for all databases
          - node.labels.database == true

networks:
  traefik-public:
    external: true

volumes:
  all_data:
    driver: local
    driver_opts:
      type: "cifs"
      o: "username=${SMB_USERNAME},password=${SMB_PASSWORD},domain=${SMB_DOMAIN},vers=3.0,nobrl,uid=0,gid=100,file_mode=0777,dir_mode=0777,ro,soft,actimeo=30"
      device: "//${NAS_SERVER}/all_data"
  immich_upload:
    driver: local
    driver_opts:
      type: "cifs"
      o: "username=${SMB_USERNAME},password=${SMB_PASSWORD},domain=${SMB_DOMAIN},vers=3.0,nobrl,uid=${PUID},gid=${PGID},file_mode=0644,dir_mode=0770,soft,actimeo=30"
      device: "//${NAS_SERVER}/immich_upload"
  immich_pgdata:
    driver: local
    # CRITICAL: Database volumes MUST be on local storage for performance
    # Network storage (CIFS/NFS) causes severe performance degradation and timeouts
    # This volume will be created on the node where immich-postgres is deployed
  immich_model_cache:
    driver: local
    # ML model cache should be on local storage for performance
    # Network storage would add latency to face detection and object recognition
    # This volume will be created on the node where immich-machine-learning is deployed
  immich_redis_data:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/mnt/iscsi/cache/immich-redis"
